language: node_js
node_js:
  - '14.17.0'

before_deploy: "echo 'Travis CI starting up!!!'"

jobs:
  include:
    - stage: testing
      if: branch in (main, dev)
      before_install: # before npm install
        - "echo 'INSTALLING npm packages'"
        - npm install
        - "echo 'Bumping version number'"
        - npm --no-git-tag-version version patch
      script: # before running test
        - "echo 'RUNNING Jest tests'"
        - npm touch bigQueryServiceCredentials.json '{
  "type": "service_account",
  "project_id": $TEST_PROJECT_ID,
  "private_key_id": $TEST_PRIVATE_KEY_ID,
  "private_key": $TEST_PRIVATE_KEY,
  "client_email": $TEST_CLIENT_EMAIL,
  "client_id": $TEST_CLIENT_ID,
  "auth_uri": "https://accounts.google.com/o/oauth2/auth",
  "token_uri": "https://oauth2.googleapis.com/token",
  "auth_provider_x509_cert_url": "https://www.googleapis.com/oauth2/v1/certs",
  "client_x509_cert_url": $TEST_CLIENT_X509_CERT_URL,
}'
        - ls
        - npm test
      after_success: # after test is ru
        - "echo 'Travis CI checks and Jest tests have passed!!'"
        - "echo 'Deploying to NPM'"
      deploy:
        on:
          branch: dev
        provider: npm
        email: 'michael.e.colley@googlemail.com'
        api_key: $NPM-TOKEN
